---
title: "Model 3 Neg Binom"
author: "Ben Moolman, Craig Orman, Ethan Pross"
output: pdf_document
---


```{r, echo=FALSE, warning=FALSE, message=FALSE}
library(dplyr)
library(tidyverse)
library(knitr)
library(ggplot2)
library(coda)
```

## Beginning Data preparing

```{r, warning = FALSE, message = FALSE, echo = FALSE}
original_tbl <- read.csv("./NBA-BoxScores-2023-2024.csv")


original_tbl <- mutate(original_tbl,
                       START_POSITION = na_if(START_POSITION, ""),
                       START_POSITION = factor(original_tbl$START_POSITION),
                       COMMENT = na_if(COMMENT, ""),
                       COMMENT = factor(original_tbl$COMMENT),
                       MIN = na_if(MIN, ""),
                       MIN = str_replace(MIN, "([0-9]+)\\.[0-9]+:", "\\1:"),
                       )

starting_dat = original_tbl[original_tbl$START_POSITION != "",]
lebron_vs_steph_games = c(22300650, 22300973, 22301155)

# Code to add in opposing team

game_registry <- distinct(starting_dat[,c(2,3, 4)]) %>%
  group_by(GAME_ID) %>%
  arrange(TEAM_ID, .by_group = TRUE) %>%
  mutate(slot = paste0("TEAM", row_number())) %>%
  pivot_wider(
    names_from = slot,
    values_from = c(TEAM_ID, TEAM_ABBREVIATION),
    names_sep = "_"
  )

colnames(game_registry) <- c("Game_ID", "Team_1_ID", "Team_2_ID", "Team_1_Abbrev", "Team_2_Abbrev")


starting_dat$Opposing_Team_Name_ID = NA
starting_dat$Opposing_Team_Name = NA

starting_dat <- starting_dat %>%
  left_join(game_registry, by = c("GAME_ID" = "Game_ID")) %>%
  mutate(
    Opposing_Team_Name_ID = if_else(
      TEAM_ID == Team_1_ID, Team_2_ID,
      if_else(TEAM_ID == Team_2_ID, Team_1_ID, NA_integer_)
    ),
    Opposing_Team_Name = if_else(
      TEAM_ID == Team_1_ID, Team_2_Abbrev,
      if_else(TEAM_ID == Team_2_ID, Team_1_Abbrev, NA_character_)
    )
  ) %>%
  select(-Team_1_ID, -Team_2_ID, -Team_1_Abbrev, -Team_2_Abbrev)

```

```{r, warning=FALSE}
## Ben's DRTG code!
# Calculate total points per team per game
# here, datatest2 is the entire data frame that is not filtered for starters
# filtering dataset to remove NAs which arise a player doesnt record any minutes in the game (sitting out)
team_points <- na.omit(original_tbl) %>%
  group_by(GAME_ID, TEAM_ID) %>%
  summarize(TeamPoints = sum(PTS), .groups = "drop")

# 
team_points_opponent <- team_points %>%
  rename(OPP_TEAM_ID = TEAM_ID, OpponentPoints = TeamPoints)

# join and filter
team_vs_opponent <- team_points %>%
  inner_join(team_points_opponent, by = "GAME_ID") %>%
  filter(TEAM_ID != OPP_TEAM_ID)

# calculate average opponent points per team (our DRTG)
team_drtg <- team_vs_opponent %>%
  group_by(TEAM_ID) %>%
  summarize(DRTG_proxy = mean(OpponentPoints), n_games = n(), .groups = "drop")

range(team_drtg$DRTG_proxy)
mean(team_drtg$DRTG_proxy)
```
DRTG data being joined to the starting data

```{r, warning=FALSE}
## NOW ADDING DRTG vars to original_tbl


# Each team plays one opponent per game, so we pair them like this:
game_team_pairs <- original_tbl %>%
  select(GAME_ID, TEAM_ID) %>%
  distinct()

# Join to get each game twice: once for each team, with their opponent
opponent_map <- game_team_pairs %>%
  inner_join(game_team_pairs, by = "GAME_ID") %>%
  filter(TEAM_ID.x != TEAM_ID.y) %>%
  rename(TEAM_ID = TEAM_ID.x, OPP_TEAM_ID = TEAM_ID.y)

# Add opponent DRTG to the mapping
opponent_map <- opponent_map %>%
  left_join(team_drtg %>% rename(OPP_TEAM_ID = TEAM_ID, OPP_DRTG = DRTG_proxy),
            by = "OPP_TEAM_ID")

# Join to add opponent DRTG column to the full data
starting_dat <- starting_dat %>%
  left_join(opponent_map, by = c("GAME_ID", "TEAM_ID"))

mean_drtg <- mean(team_drtg$DRTG_proxy)
starting_dat <- starting_dat %>%
  mutate(centered_OPP_DRTG = OPP_DRTG - mean_drtg)
```